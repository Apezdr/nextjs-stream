## Active Context

- **What you're working on now:** Implemented selective update pattern for captions.js and posters.js to prevent update loops and maintain data integrity across multiple servers.

- **Recent changes:** 
  - Updated videoInfo.js to include mediaQuality fields for movies and TV shows
  - Added support for gathering and storing mediaQuality information from file servers
  - Enhanced the priority-based field selection to include mediaQuality fields
  - Updated database update logic to handle mediaQuality data
  - Fixed the nested mediaQuality field handling to properly check priority for each specific field
  - Implemented separate processing for mediaQuality fields in both movie and TV episode handling
  - Fixed comparison logic in finalizeSeasonVideoInfo and finalizeMovieVideoInfo to properly check if fields exist before comparing them
  - Added proper null/undefined checks for hdr and size fields to prevent unnecessary updates
  - Implemented priority tracking for each field in gatherMovieVideoInfoForAllServers and gatherSeasonVideoInfoForAllServers
  - Added logic to prevent lower priority servers from overwriting data from higher priority servers
  - Improved null/undefined value handling to skip these values entirely rather than potentially overwriting valid data
  - Fixed field paths in captions.js to match the actual data structure:
    - For movies: `urls.subtitles.${lang}.url`
    - For TV episodes: `seasons.Season ${season.seasonNumber}.episodes.${episodeFileName}.subtitles.${lang}.url`
  - Implemented selective caption updates in finalizeMovieCaptions and finalizeSeasonCaptions:
    - Start with current captions from the database instead of creating empty objects
    - Only update captions that are from the current server or are new
    - Preserve captions from other servers that aren't being updated
    - Only mark as changed if there are actual differences in URL or lastModified timestamp
  - Added specific comparison logic to prevent update loops between servers:
    - Each server only updates its own captions or adds new ones
    - Maintains proper priority-based selection during the gathering phase
    - Preserves captions from other servers during updates
  - Enhanced poster update logic in posters.js with selective update pattern:
    - Modified processShowPosterURL, processMoviePosterURL, and processSeasonPosters to only update posters from the current server
    - Added ownership check to ensure a server only updates posters it owns or adds new ones
    - Improved comparison logic to prevent unnecessary updates
    - Added "(selective update)" to log messages for clarity

- **Next steps:** 
  - Test the selective update implementations with real data to confirm they properly preserve data from different servers
  - Verify that data from multiple servers can coexist without creating update loops
  - Consider applying similar selective update patterns to other sync modules (backdrops, thumbnails, etc.)
  - Update documentation to reflect the selective update approach for multi-server data
  - Explore additional optimizations for the sync process to further reduce unnecessary database updates
  - Consider adding more granular logging to track which specific data is being updated and from which servers
